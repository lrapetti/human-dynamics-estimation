<?xml version="1.0" encoding="UTF-8" ?>
<robot name="new-hde-setup" build=0 portprefix="">

    <device type="transformServer" name="TransformServer">
        <param name="transforms_lifetime">0.2</param>
        <group name="ROS">
            <param name="enable_ros_publisher">true</param>
            <param name="enable_ros_subscriber">false</param>
        </group>
    </device>

    <device type="iwear_remapper" name="XSenseIWearRemapper">
        <param name="wearableDataPorts">(/XSensSuit/WearableData/data:o)</param>
        <param name="wearableRPCPorts">(/XSensSuit/WearableData/metadataRpc:o)</param>
        <param name="outputPortName">/HDE/XsensIWearRemapper/data:o</param>
    </device>

    <device type="human_state_provider" name="HumanStateProvider">
        <param name="period">0.02</param>
        <!-- <param name="urdf">Claudia66DoF_noLimit.urdf</param> -->
        <param name="urdf">Claudia66DoF_2PILimit.urdf</param>
        <!-- <param name="urdf">Claudia66DoF_e16Limit.urdf</param> -->
        <param name="floatingBaseFrame">(Pelvis, XsensSuit::vLink::Pelvis)</param>
        <param name="allowIKFailures">true</param>
        <param name="maxIterationsIK">300</param>
        <param name="costTolerance">0.7</param>
        <param name="useXsensJointsAngles">true</param>
        <!-- TODO: How to use a reduced model in the entire HDE? (Starting from HumanStateProvider) -->
        <group name="MODEL_TO_DATA_LINK_NAMES">
            <param name="map_Pelvis">(Pelvis, XsensSuit::vLink::Pelvis)</param>
            <param name="map_L5">(L5, XsensSuit::vLink::L5)</param>
            <param name="map_L3">(L3, XsensSuit::vLink::L3)</param>
            <param name="map_T12">(T12, XsensSuit::vLink::T12)</param>
            <param name="map_T8">(T8, XsensSuit::vLink::T8)</param>
            <param name="map_Neck">(Neck, XsensSuit::vLink::Neck)</param>
            <param name="map_Head">(Head, XsensSuit::vLink::Head)</param>
            <param name="map_RightShoulder">(RightShoulder, XsensSuit::vLink::RightShoulder)</param>
            <param name="map_RightUpperArm">(RightUpperArm, XsensSuit::vLink::RightUpperArm)</param>
            <param name="map_RightForeArm">(RightForeArm, XsensSuit::vLink::RightForeArm)</param>
            <param name="map_RightHand">(RightHand, XsensSuit::vLink::RightHand)</param>
            <param name="map_LeftShoulder">(LeftShoulder, XsensSuit::vLink::LeftShoulder)</param>
            <param name="map_LeftUpperArm">(LeftUpperArm, XsensSuit::vLink::LeftUpperArm)</param>
            <param name="map_LeftForeArm">(LeftForeArm, XsensSuit::vLink::LeftForeArm)</param>
            <param name="map_LeftHand">(LeftHand, XsensSuit::vLink::LeftHand)</param>
            <param name="map_RightUpperLeg">(RightUpperLeg, XsensSuit::vLink::RightUpperLeg)</param>
            <param name="map_RightLowerLeg">(RightLowerLeg, XsensSuit::vLink::RightLowerLeg)</param>
            <param name="map_RightFoot">(RightFoot, XsensSuit::vLink::RightFoot)</param>
            <param name="map_RightToe">(RightToe, XsensSuit::vLink::RightToe)</param>
            <param name="map_LeftUpperLeg">(LeftUpperLeg, XsensSuit::vLink::LeftUpperLeg)</param>
            <param name="map_LeftLowerLeg">(LeftLowerLeg, XsensSuit::vLink::LeftLowerLeg)</param>
            <param name="map_LeftFoot">(LeftFoot, XsensSuit::vLink::LeftFoot)</param>
            <param name="map_LeftToe">(LeftToe, XsensSuit::vLink::LeftToe)</param>
        </group>
        <group name="SPHERICAL_LINK_DESCRIPTION">
           <!-- Example: (werable spherical joint, jointx, jointy, jointz, parent, child) -->
           <param name="sperical_jL5S1">(XsensSuit::vSJoint::jL5S1, jL5S1_rotx, jL5S1_roty, jL5S1_rotz, Pelvis, L5)</param>
           <param name="sperical_jL4L3">(XsensSuit::vSJoint::jL4L3, jL5S1_rotx, jL4L3_roty, jL4L3_rotz, L5, L3)</param>
           <param name="sperical_jL1T12">(XsensSuit::vSJoint::jL1T12, jL1T12_rotx, jL1T12_roty, jL1T12_rotz, L3, T12)</param>
           <param name="sperical_jT9T8">(XsensSuit::vSJoint::jT9T8, jT9T8_rotx, jT9T8_roty, jT9T8_rotz, T12, T8)</param>
           <param name="sperical_jT1C7">(XsensSuit::vSJoint::jT1C7, jT1C7_rotx, jT1C7_roty, jT1C7_rotz, T8, Neck)</param>
           <param name="sperical_jC1Head">(XsensSuit::vSJoint::jC1Head, jC1Head_rotx, jC1Head_roty, jC1Head_rotz, Neck, Head)</param>
           <param name="sperical_jRightC7Shoulder">(XsensSuit::vSJoint::jRightT4Shoulder, jRightC7Shoulder_rotx, jRightC7Shoulder_roty, jRightC7Shoulder_rotz, T8, RightShoulder)</param>
           <param name="sperical_jRightShoulder">(XsensSuit::vSJoint::jRightShoulder, jRightShoulder_rotx, jRightShoulder_roty, jRightShoulder_rotz, RightShoulder, RightUpperArm)</param>
           <param name="sperical_jRightElbow">(XsensSuit::vSJoint::jRightElbow, jRightElbow_rotx, jRightElbow_roty, jRightElbow_rotz, RightUpperArm, RightForeArm)</param>
           <param name="sperical_jRightWrist">(XsensSuit::vSJoint::jRightWrist, jRightWrist_rotx, jRightWrist_roty, jRightWrist_rotz, RightForeArm, RightHand)</param>
           <param name="sperical_jLeftC7Shoulder">(XsensSuit::vSJoint::jLeftT4Shoulder, jLeftC7Shoulder_rotx, jLeftC7Shoulder_roty, jLeftC7Shoulder_rotz, T8, LeftShoulder)</param>
           <param name="sperical_jLeftShoulder">(XsensSuit::vSJoint::jLeftShoulder, jLeftShoulder_rotx, jLeftShoulder_roty, jLeftShoulder_rotz, LeftShoulder, LeftUpperArm)</param>
           <param name="sperical_jLeftElbow">(XsensSuit::vSJoint::jLeftElbow, jLeftElbow_rotx, jLeftElbow_roty, jLeftElbow_rotz, LeftUpperArm, LeftForeArm)</param>
           <param name="sperical_jLeftWrist">(XsensSuit::vSJoint::jLeftWrist, jLeftWrist_rotx, jLeftWrist_roty, jLeftWrist_rotz, LeftForeArm, LeftHand)</param>
           <param name="sperical_jRightHip">(XsensSuit::vSJoint::jRightHip, jRightHip_rotx, jRightHip_roty, jRightHip_rotz, Pelvis, RightUpperLeg)</param>
           <param name="sperical_jRightKnee">(XsensSuit::vSJoint::jRightKnee, jRightKnee_rotx, jRightKnee_roty, jRightKnee_rotz, RightUpperLeg, RightLowerLeg)</param>
           <param name="sperical_jRightAnkle">(XsensSuit::vSJoint::jRightAnkle, jRightAnkle_rotx, jRightAnkle_roty, jRightAnkle_rotz, RightLowerLeg, RightFoot)</param>
           <param name="sperical_jRightBallFoot">(XsensSuit::vSJoint::jRightBallFoot, jRightBallFoot_rotx, jRightBallFoot_roty, jRightBallFoot_rotz, RightFoot, RightToe)</param>
           <param name="sperical_jLeftHip">(XsensSuit::vSJoint::jLeftHip, jLeftHip_rotx, jLeftHip_roty, jLeftHip_rotz, Pelvis, LeftUpperLeg)</param>
           <param name="sperical_jLeftKnee">(XsensSuit::vSJoint::jLeftKnee, jLeftKnee_rotx, jLeftKnee_roty, jLeftKnee_rotz, LeftUpperLeg, LeftLowerLeg)</param>
           <param name="sperical_jLeftAnkle">(XsensSuit::vSJoint::jLeftAnkle, jLeftAnkle_rotx, jLeftAnkle_roty, jLeftAnkle_rotz, LeftLowerLeg, LeftFoot)</param>
           <param name="sperical_jLeftBallFoot">(XsensSuit::vSJoint::jLeftBallFoot, jLeftBallFoot_rotx, jLeftBallFoot_roty, jLeftBallFoot_rotz, LeftFoot, LeftToe)</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateProviderLabel">XSenseIWearRemapper</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_state_wrapper" name="HumanStateWrapper">
        <param name="period">0.02</param>
        <param name="outputPort">/HDE/HumanStateWrapper/state:o</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateWrapperLabel">HumanStateProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_state_publisher" name="HumanStatePublisher">
        <param name="period">0.020</param>
        <param name="baseTFName">/Human/Pelvis</param>
        <param name="humanJointsTopic">/Human/joint_states</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStatePublisherLabel">HumanStateProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="iwear_remapper" name="FTSourcesIWearRemapper">
        <param name="wearableDataPorts">(/FTShoeLeft/WearableData/data:o /FTShoeRight/WearableData/data:o)</param>
        <param name="wearableRPCPorts">(/FTShoeLeft/WearableData/metadataRpc:o /FTShoeRight/WearableData/metadataRpc:o)</param>
        <param name="outputPortName">/HDE/FTSourcesIWearRemapper/data:o</param>
    </device>

    <device type="human_wrench_provider" name="HumanWrenchProvider">
        <param name="period">0.100</param>
        <param name="human_urdf">Claudia66DoF.urdf</param>
        <param name="robot_urdf">model.urdf</param>
        <param name="number_of_source_devices">3</param>
        <param name="number_of_sources">2</param>
        <param name="sources">(FTShoeLeft FTShoeRight)</param>
        <group name="FTShoeLeft">
            <param name="sensorName">FTShoes::ft6D::LeftFTShoe</param>
            <param name="outputFrame">LeftFoot</param>
            <param name="type">fixed</param>
            <param name="rotation">(1.0 0.0 0.0
                                    0.0 1.0 0.0
                                    0.0 0.0 1.0)</param>
            <param name="position">(-0.0026 0.0 -0.1208)</param>
        </group>
        <group name="FTShoeRight">
            <param name="sensorName">FTShoes::ft6D::RightFTShoe</param>
            <param name="outputFrame">RightFoot</param>
            <param name="type">fixed</param>
            <param name="rotation">(1.0 0.0 0.0
                                    0.0 1.0 0.0
                                    0.0 0.0 1.0)</param>
            <param name="position">(-0.0026 0.0 -0.1208)</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                 <elem name="HumanWrenchProviderLabelFTShoeLeft">FTSourcesIWearRemapper</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach" />
    </device>

    <device type="analogServer" name="HumanWrenchWrapper">
        <param name="name">/HDE/HumanWrenchWrapper/wrench:o</param>
        <param name="period">10</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanWrenchWrapperLabel">HumanWrenchProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach" />
    </device>

    <!--Wrapper to publish WrenchStamped message to Rviz-->
    <device type="analogServer" name="HumanWrenchPublisher">
        <param name="name">/HDE/HumanWrenchPublisher/wrench:o</param>
        <param name="period">20</param>
        <param name="channels">12</param>
        <paramlist name="ports">
            <elem name="FirstSetOfChannels">0 5 0 5</elem>
            <elem name="SecondSetOfChannels">6 11 0 5</elem>
        </paramlist>
        <group name="ROS">
            <param name="useROS">true</param>
            <param name="ROS_topicName">(/HDE/WrenchStamped/LeftFoot /HDE/WrenchStamped/RightFoot)</param>
            <param name="ROS_nodeName">/HDE/HumanWrenchPublisherNode</param>
            <param name="ROS_msgType">geometry_msgs/WrenchStamped</param>
            <param name="frame_id">(Human/LeftFoot Human/RightFoot)</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanWrenchPublisherLabel">HumanWrenchProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach" />
    </device>

    <device type="human_dynamics_estimator" name="HumanDynamicsEstimator">
        <param name="period">0.100</param>
        <param name="urdf">Claudia66DoF.urdf</param>
        <param name="baseLink">Pelvis</param>
        <param name="number_of_wrench_sensors">2</param>
        <param name="wrench_sensors_link_name">(LeftFoot RightFoot)</param>
        <group name="PRIORS">
            <param name="cov_dyn_variables">10000.0</param>
            <param name="cov_dyn_constraints">0.0001</param>
            <param name="mu_dyn_variables">0.0001</param>
            <param name="cov_measurements_ACCELEROMETER_SENSOR">(0.0011 0.0011 0.0011)</param>
            <param name="cov_measurements_DOF_ACCELERATION_SENSOR">0.666e-5</param>
            <group name="cov_measurements_NET_EXT_WRENCH_SENSOR">
                <param name="value">1e-6</param>
                <param name="specific_elements">(LeftFoot RightFoot)</param>
                <param name="LeftFoot">(0.0589998348 0.0589998348 0.0359999712 0.002250000225 0.002250000225 0.56e-3)</param>
                <param name="RightFoot">(0.0589998348 0.0589998348 0.0359999712 0.002250000225 0.002250000225 0.56e-3)</param>
            </group>
        </group>
        <group name="SENSORS_REMOVAL">
            <param name="GYROSCOPE_SENSOR">*</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsEstimatorLabel1">HumanStateProvider</elem>
                <elem name="HumanDynamicsEstimatorLabel2">HumanWrenchProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_dynamics_wrapper" name="HumanDynamicsWrapper">
        <param name="period">0.1</param>
        <param name="outputPort">/HDE/HumanDynamicsWrapper/torques:o</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsWrapperLabel">HumanDynamicsEstimator</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_dynamics_publisher" name="HumanDynamicsPublisher">
        <param name="period">0.020</param>
        <param name="parentLinkNames">(LeftFoot LeftLowerLeg LeftUpperLeg LeftHand LeftForeArm LeftUpperArm RightFoot RightLowerLeg RightUpperLeg RightHand RightForeArm RightUpperArm)</param>
        <param name="sphericalJointNames">(jLeftAnkle jLeftKnee jLeftHip jLeftWrist jLeftElbow jLeftShoulder jRightAnkle jRightKnee jRightHip jRightWrist jRightElbow jRightShoulder)</param>
        <param name="topicPrefix">/HumanEffortBridge</param>
        <param name="tfPrefix">Human</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsPublisherLabel">HumanDynamicsEstimator</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

</robot>